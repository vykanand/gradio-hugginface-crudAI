<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f5f8fa;
        margin: 0;
        padding: 0;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      h1 {
        text-align: center;
        color: #1da1f2;
        font-size: 2.5rem;
        margin-bottom: 30px;
      }
      .search-bar {
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      table th,
      table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }
      table th {
        background-color: #1da1f2;
        color: white;
        font-weight: 700;
      }
      table tr:nth-child(even) {
        background-color: #f7f9fb;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      .pagination button {
        margin: 0 5px;
        padding: 8px 12px;
        border: none;
        background-color: #1da1f2;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .pagination button.active {
        background-color: #0d6efd;
        font-weight: bold;
      }
      .pagination button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="display: flex; align-items: center; margin-left: 33.3%">
        <img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT54-gkNToOxSOLedVBuJBHmsRl4pzJXPypIA&s"
          style="width: 80px; height: 80px"
        />

        <h1 style="margin-top: 5vh">AI SQL Generator</h1>
      </div>

      <!-- Navigation Links -->
      <div
        id="tools-nav"
        style="
          margin-bottom: 20px;
          padding: 15px;
          background: #e3f2fd;
          border-radius: 8px;
        "
      >
        <p style="margin: 0; font-weight: 600; margin-bottom: 10px">
          üöÄ Other Tools:
        </p>
        <a
          href="/explorer"
          style="
            margin-right: 15px;
            color: #1da1f2;
            text-decoration: none;
            font-weight: 600;
          "
        >
          üìä Database Explorer & Schema Discovery
        </a>
        <a
          href="/config"
          style="color: #1da1f2; text-decoration: none; font-weight: 600"
        >
          ‚öôÔ∏è Database Configuration
        </a>
        <!-- Orchestration links -->
        <a
          href="/orchestration-builder.html"
          style="
            margin-left: 15px;
            margin-right: 15px;
            color: #1da1f2;
            text-decoration: none;
            font-weight: 600;
          "
        >
          üß≠ Orchestration Builder
        </a>
        <a
          href="/orchestration-manager.html"
          style="
            margin-left: 0;
            color: #1da1f2;
            text-decoration: none;
            font-weight: 600;
          "
        >
          ‚öôÔ∏è Orchestration Manager
        </a>
        <a
          href="/orchestration-monitor.html"
          style="
            margin-left: 12px;
            color: #1da1f2;
            text-decoration: none;
            font-weight: 600;
          "
        >
          üîç Orchestration Monitor
        </a>
      </div>

      <!-- Search Bar -->
      <div class="input-group mb-3 search-bar">
        <select
          id="table-select"
          class="form-select"
          style="max-width: 300px; margin-right: 8px"
        >
          <option value="">Select table...</option>
        </select>
        <input
          type="text"
          id="search-input"
          class="form-control"
          placeholder="Enter your db prompt"
          aria-label="Search prompt"
          aria-describedby="button-addon2"
        />
        <button class="btn btn-primary" type="button" id="search-button">
          Run!
        </button>
      </div>

      <div
        id="query-display"
        class="alert alert-info"
        style="display: none; margin-bottom: 20px"
      >
        <strong>Executed Query:</strong>
        <pre
          id="query-text"
          style="margin-top: 10px; white-space: pre-wrap"
        ></pre>
        <div
          id="error-container"
          style="
            margin: 20px;
            padding: 15px;
            border: 1px solid #ff4444;
            border-radius: 4px;
            display: none;
          "
        >
          <h3 style="color: #ff4444">Query Failed</h3>
          <div>
            <strong>Failed Query:</strong>
            <pre
              id="failed-query"
              style="background: #f8f8f8; padding: 10px"
            ></pre>
          </div>
          <div>
            <strong>Error Details:</strong>
            <pre
              id="error-details"
              style="background: #f8f8f8; padding: 10px"
            ></pre>
          </div>
        </div>
      </div>

      <div id="item-table" class="loading text-center">Loading...</div>
      <div id="pagination" class="pagination"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/client-config.js"></script>
    <script>
      let currentPage = 1;
      const itemsPerPage = 5;
      let selectedSchemas = {};

      // Ensure runtime config is available
      async function ensureRuntimeConfigClient() {
        if (window.__RUNTIME_CONFIG__) {
          window.RUNTIME_CONFIG = window.__RUNTIME_CONFIG__;
          return window.RUNTIME_CONFIG;
        }
        try {
          const r = await fetch("/runtime-config");
          window.RUNTIME_CONFIG = await r.json();
          return window.RUNTIME_CONFIG;
        } catch (e) {
          console.warn("Could not load runtime config, using defaults", e);
          window.RUNTIME_CONFIG = {
            ai: { mode: "proxy", directUrl: "/large" },
          };
          return window.RUNTIME_CONFIG;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await ensureRuntimeConfigClient();
        init();
      });

      async function init() {
        try {
          // Fetch available configurations to decide whether to show explorer first
          const configsRes = await axios.get("/api/configs");
          const configs = configsRes.data || {};
          const active = configs.activeConfig;

          const urlParams = new URLSearchParams(window.location.search);
          const selectedTablesParam = urlParams.get("selectedTables");

          // Previously auto-redirected to /explorer when an active config existed.
          // Stop auto-redirecting; instead show a prominent button users can click.
          if (!selectedTablesParam && active) {
            const nav = document.getElementById("tools-nav");
            if (nav) {
              const banner = document.createElement("div");
              banner.style.marginTop = "10px";
              banner.innerHTML =
                '<div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;"><div style="flex:1; font-weight:600; color:#0d6efd">Active DB configuration detected.</div><a href="/explorer" class="btn btn-outline-primary">Open Database Explorer</a></div>';
              nav.appendChild(banner);
            }
          }

          // Otherwise continue loading tables and UI
          await loadAvailableTables();

          document
            .getElementById("search-button")
            .addEventListener("click", () => {
              const prompt = document
                .getElementById("search-input")
                .value.trim();
              if (prompt) {
                currentPage = 1;
                fetchItems(prompt);
              }
            });

          // If redirected from explorer with selectedTables, preselect them
          if (selectedTablesParam) {
            const sel = document.getElementById("table-select");
            const tables = selectedTablesParam
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean);
            for (const t of tables) {
              const option = sel.querySelector(`option[value="${t}"]`);
              if (option) option.selected = true;
              // try to load persisted schema for this table
              try {
                const resp = await axios.get(
                  `/schema-store/table/${encodeURIComponent(t)}`
                );
                if (resp.data && resp.data.table && resp.data.table.schema) {
                  selectedSchemas[t] = resp.data.table.schema;
                }
              } catch (e) {
                console.warn("No persisted schema for", t);
              }
            }
            // show selected schema summary and AI chat UI
            renderSelectedSchemaSummary(selectedSchemas);
          }
        } catch (e) {
          console.error("Init error:", e.message);
          // still try to load tables if configs endpoint failed
          try {
            await loadAvailableTables();
          } catch (_) {}
        }
      }

      // Render selected schema summary and a lightweight AI chat UI
      function renderSelectedSchemaSummary(schemaObj) {
        const container = document.getElementById("item-table");
        let html = "";
        for (const t of Object.keys(schemaObj)) {
          const s = schemaObj[t];
          const cols = (s.columns || [])
            .map((c) => `${c.Field} (${c.Type})`)
            .join(", ");
          html += `<div style="margin-bottom:12px; padding:12px; border:1px solid #e8e8e8; border-radius:6px;"><strong>${t}</strong><div style="font-size:0.9rem; color:#555; margin-top:8px">${cols}</div></div>`;
        }
        if (!html)
          html =
            '<div class="alert alert-info">No persisted schema details available for selected tables.</div>';
        // append AI chat UI below the schema summary
        html += `
          <div style="margin-top:16px;">
            <div id="ai-chat" style="border:1px solid #e0e0e0; padding:12px; border-radius:6px; background:#fff">
              <div id="ai-messages" style="max-height:300px; overflow:auto; margin-bottom:8px;"></div>
              <div style="display:flex; gap:8px;"><input id="ai-input" class="form-control" placeholder="Ask about selected schema or request SQL..."/><button id="ai-send" class="btn btn-primary">Send</button></div>
              <div id="ai-sql-result" style="margin-top:12px"></div>
            </div>
          </div>
        `;
        container.innerHTML = html;

        document
          .getElementById("ai-send")
          .addEventListener("click", sendAiChat);
        document
          .getElementById("ai-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendAiChat();
          });
      }

      async function sendAiChat() {
        const input = document.getElementById("ai-input");
        const msg = input.value.trim();
        if (!msg) return;
        appendAiMessage("user", msg);
        input.value = "";

        // Build context from selectedSchemas
        let context = "Selected tables:\n";
        for (const t of Object.keys(selectedSchemas)) {
          const s = selectedSchemas[t];
          context += `\nTable: ${t}\nColumns: ${(s.columns || [])
            .map((c) => `${c.Field} (${c.Type})`)
            .join(", ")}\nRow count: ${s.rowCount || 0}\n`;
        }

        const payload = {
          sessionId: "index-chat-" + Date.now(),
          aiquestion: context + "\n\nUser question: " + msg,
        };

        try {
          const aiTarget =
            window.RUNTIME_CONFIG &&
            window.RUNTIME_CONFIG.ai &&
            window.RUNTIME_CONFIG.ai.mode === "direct"
              ? window.RUNTIME_CONFIG.ai.directUrl
              : "/ai/send";
          const r = await axios.post(aiTarget, payload, { timeout: 60000 });
          let aiText = "";
          if (typeof r.data === "string") {
            try {
              aiText = JSON.parse(r.data).response || r.data;
            } catch (e) {
              aiText = r.data;
            }
          } else if (r.data && r.data.response) aiText = r.data.response;
          else aiText = JSON.stringify(r.data);

          appendAiMessage("ai", aiText);

          // detect SQL in AI response
          const sqlMatch =
            aiText.match(/```sql\n([\s\S]*?)\n```/i) ||
            aiText.match(
              /(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)[\s\S]*?;/i
            );
          if (sqlMatch) {
            const sql = sqlMatch[1] || sqlMatch[0];
            showSqlResult(sql.trim());
          }
        } catch (e) {
          appendAiMessage("ai", "Error contacting AI: " + e.message);
        }
      }

      function appendAiMessage(who, text) {
        const box = document.getElementById("ai-messages");
        const el = document.createElement("div");
        el.style.marginBottom = "8px";
        el.style.padding = "8px";
        el.style.borderRadius = "6px";
        el.style.maxWidth = "85%";
        if (who === "user") {
          el.style.background = "#1da1f2";
          el.style.color = "white";
          el.style.marginLeft = "auto";
        } else {
          el.style.background = "#f4f6f8";
          el.style.color = "#222";
        }
        el.innerHTML = text.replace(/\n/g, "<br>");
        box.appendChild(el);
        box.scrollTop = box.scrollHeight;
      }

      function showSqlResult(sql) {
        const cont = document.getElementById("ai-sql-result");
        const tableSelectHtml = `<label style="margin-right:8px">Execute on:</label><select id="exec-table" class="form-select" style="display:inline-block; width:auto; margin-right:8px">${Object.keys(
          selectedSchemas
        )
          .map((t) => `<option value="${t}">${t}</option>`)
          .join("")}</select>`;
        cont.innerHTML = `<div style="padding:8px; border:1px solid #e0e0e0; border-radius:6px;"><pre style="background:#fafafa;padding:8px">${sql}</pre>${tableSelectHtml}<button id="exec-sql-btn" class="btn btn-sm btn-success">Execute SQL</button></div>`;
        document
          .getElementById("exec-sql-btn")
          .addEventListener("click", async () => {
            const table = document.getElementById("exec-table").value;
            try {
              const r = await axios.post(
                "/execute-sql",
                { sql },
                { timeout: 60000 }
              );
              if (r.data && r.data.ok) {
                const rows = r.data.data || [];
                appendAiMessage(
                  "ai",
                  `Query executed. Returned ${rows.length} rows.`
                );
                // show small preview
                const preview = rows
                  .slice(0, 10)
                  .map((row) => JSON.stringify(row))
                  .join("\n");
                appendAiMessage("ai", `<pre>${preview}</pre>`);
              } else {
                appendAiMessage(
                  "ai",
                  "Execution failed: " + JSON.stringify(r.data)
                );
              }
            } catch (e) {
              appendAiMessage("ai", "Execution error: " + e.message);
            }
          });
      }

      async function fetchItems(prompt) {
        const tableContainer = document.getElementById("item-table");
        const queryDisplay = document.getElementById("query-display");
        const queryText = document.getElementById("query-text");
        const errorContainer = document.getElementById("error-container");

        tableContainer.innerHTML =
          '<div class="spinner-border text-primary" role="status"></div> Loading items...';
        errorContainer.style.display = "none";
        queryDisplay.style.display = "none";

        const selectedTable = document.getElementById("table-select")?.value;
        const endpoint = selectedTable
          ? `/` + encodeURIComponent(selectedTable)
          : new URLSearchParams(window.location.search).get("endpoint") || null;
        if (!endpoint) {
          tableContainer.innerHTML =
            '<div class="alert alert-warning">No table selected. Please select a table to run queries.</div>';
          return;
        }
        prompt = prompt || "select all";

        try {
          const response = await axios.post(
            endpoint,
            { prompt },
            {
              timeout: 60000, // 60 second timeout
            }
          );

          if (response.status === 200) {
            // Display the executed query
            queryText.textContent = response.data.query;
            queryDisplay.style.display = "block";

            // Handle the data
            const items = response.data.data;
            if (Array.isArray(items) && items.length > 0) {
              setupPagination(items);
              renderTable(items, currentPage);
            } else {
              tableContainer.innerHTML =
                '<div class="alert alert-warning">No items found.</div>';
            }
          }
        } catch (error) {
          console.error("Error fetching items:", error);
          tableContainer.innerHTML = "";

          if (error.response && error.response.data) {
            handleQueryError({
              query: error.response.data.query || "Unknown query",
              details:
                error.response.data.details ||
                error.response.data.error ||
                error.message,
            });
          } else if (error.request) {
            // Request was made but no response received
            tableContainer.innerHTML =
              '<div class="alert alert-danger">Cannot connect to server. Please make sure the server is running.</div>';
          } else {
            // Something else happened
            tableContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
          }
        }
      }

      function setupPagination(items) {
        const paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = "";

        const totalPages = Math.ceil(items.length / itemsPerPage);

        for (let i = 1; i <= totalPages; i++) {
          const button = document.createElement("button");
          button.innerText = i;
          button.classList.toggle("active", i === currentPage);
          button.addEventListener("click", () => {
            currentPage = i;
            renderTable(items, currentPage);
            setupPagination(items); // Update active state
          });
          paginationContainer.appendChild(button);
        }
      }

      function renderTable(items, page) {
        const tableContainer = document.getElementById("item-table");
        tableContainer.innerHTML = "";

        const start = (page - 1) * itemsPerPage;
        const end = page * itemsPerPage;
        const paginatedItems = items.slice(start, end);

        const table = document.createElement("table");
        const headerRow = document.createElement("tr");

        const headers = Object.keys(paginatedItems[0]);
        headers.forEach((header) => {
          const th = document.createElement("th");
          th.innerText = header.charAt(0).toUpperCase() + header.slice(1);
          headerRow.appendChild(th);
        });

        table.appendChild(headerRow);

        paginatedItems.forEach((item) => {
          const row = document.createElement("tr");
          Object.keys(item).forEach((key) => {
            const cell = document.createElement("td");
            cell.innerText = item[key];
            row.appendChild(cell);
          });
          table.appendChild(row);
        });

        tableContainer.appendChild(table);
      }

      async function loadAvailableTables() {
        try {
          const res = await axios.get("/database");
          const tables = res.data?.tables || [];
          const sel = document.getElementById("table-select");
          sel.innerHTML =
            '<option value="">Select table...</option>' +
            tables.map((t) => `<option value="${t}">${t}</option>`).join("");
          // enable search only if tables available
          sel.onchange = () => {
            // clear previous results
            document.getElementById("item-table").innerHTML = "";
          };
        } catch (e) {
          console.error("Failed to load table list:", e.message);
        }
      }

      function handleQueryError(error) {
        const errorContainer = document.getElementById("error-container");
        const failedQuery = document.getElementById("failed-query");
        const errorDetails = document.getElementById("error-details");

        errorContainer.style.display = "block";
        failedQuery.textContent = error.query || "Query not available";
        errorDetails.textContent = error.details || error.message;
      }
    </script>
  </body>
</html>
