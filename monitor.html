<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Live Monitor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 18px;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .msg {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
      }
      .subject {
        font-weight: 600;
      }
      .ts {
        color: #666;
        font-size: 0.9em;
      }
      .controls {
        margin-bottom: 12px;
      }
      #msgs {
        max-height: 60vh;
        overflow: auto;
        background: #fff;
        padding: 12px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h4>Live Monitor</h4>
      <p class="text-muted">
        Live publishes to monitored topics (non-destructive).
      </p>

      <div class="controls d-flex align-items-center" style="gap: 8px">
        <select id="subjectFilter" class="form-control" style="width: 260px">
          <option value="">All subjects</option>
          <option value="ORCHESTRATIONS.JOBS">ORCHESTRATIONS.JOBS</option>
          <option value="executions.">executions.*.events (prefix)</option>
        </select>
        <button id="clearBtn" class="btn btn-sm btn-outline-secondary">
          Clear
        </button>
        <button id="pauseBtn" class="btn btn-sm btn-outline-primary">
          Pause
        </button>
        <div style="flex: 1"></div>
        <small class="text-muted"
          >Connected to server SSE at <code>/monitor/stream</code></small
        >
      </div>

      <div id="msgs" class="mt-2"></div>
    </div>

    <script>
      let paused = false;
      const msgsEl = document.getElementById("msgs");
      const subjectFilter = document.getElementById("subjectFilter");
      const pauseBtn = document.getElementById("pauseBtn");
      const clearBtn = document.getElementById("clearBtn");

      function renderItem(item) {
        const s = item.subject || "";
        const txt =
          typeof item.data === "object"
            ? JSON.stringify(item.data, null, 2)
            : String(item.data);
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<div><span class="subject">${s}</span> <span class="ts">${
          item.ts
        }</span></div><pre>${escapeHtml(txt)}</pre>`;
        return div;
      }

      function escapeHtml(s) {
        return s.replace(/[&<>\"]/g, function (c) {
          return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
        });
      }

      function shouldShow(item) {
        const f = subjectFilter.value || "";
        if (!f) return true;
        if (f.endsWith("."))
          return item.subject && item.subject.indexOf(f) === 0;
        return item.subject === f;
      }

      function addItem(item) {
        if (!shouldShow(item)) return;
        const el = renderItem(item);
        msgsEl.insertBefore(el, msgsEl.firstChild);
        while (msgsEl.childNodes.length > 500)
          msgsEl.removeChild(msgsEl.lastChild);
      }

      fetch("/monitor/recent")
        .then((r) => r.json())
        .then((j) => {
          if (j && j.recent) j.recent.reverse().forEach(addItem);
        })
        .catch(() => {});

      const evt = new EventSource("/monitor/stream");
      evt.onmessage = function (e) {
        if (paused) return;
        try {
          const item = JSON.parse(e.data);
          addItem(item);
        } catch (err) {
          console.warn("parse err", err);
        }
      };
      evt.onerror = function (e) {
        console.warn("SSE error", e);
      };

      pauseBtn.addEventListener("click", () => {
        paused = !paused;
        pauseBtn.innerText = paused ? "Resume" : "Pause";
      });
      clearBtn.addEventListener("click", () => {
        msgsEl.innerHTML = "";
      });
    </script>
  </body>
</html>
